<!DOCTYPE html>
<html lang="es">
<head>
    <!-- 
      ¡CAMBIO! Reemplazamos todo el head por el parcial.
      La variable 'title' viene de 'views.routes.js'.
      Usamos ../partials/ porque estamos en la subcarpeta 'admin'.
    -->
    <%- include('../partials/head', { title: title }) %>
</head>
<body>

    <!-- ¡CAMBIO! Reemplazamos todo el header por el parcial. -->
    <%- include('../partials/navbar') %>

    <!-- 
      El contenido <main> y el <script> de esta página 
      permanecen idénticos, ya que su lógica es del cliente.
    -->
    <main class="admin-container"> 
        <div class="form-section">
            <h1>Consultar producto por id</h1>
            <hr>

            <form id="getProduct-form">
                <div class="form-group"> 
                    <label for="idProd">Id del producto</label>
                    <input type="number" name="idProd" id="idProd" required>
                </div>
                
                <input type="submit" value="Consultar producto" class="submit-button">
            </form>
        </div>

        <div id="contenedor-productos">
            <ul id="lista-productos"></ul>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let getProduct_form = document.getElementById("getProduct-form");
            let listaProductos = document.getElementById("lista-productos");
            let url = "/products"; // Ruta relativa
            

            getProduct_form.addEventListener("submit", async (event) => {
                event.preventDefault(); 
                listaProductos.innerHTML = ""; // Limpiamos la lista anterior

                let formData = new FormData(event.target);
                let data = Object.fromEntries(formData.entries());
                let idProd = data.idProd;
                
                try {
                    console.log(`Haciendo peticion GET a la url: ${url}/${idProd}`)
                    let respuesta = await fetch(`${url}/${idProd}`);
                    let datos = await respuesta.json();

                    if (!respuesta.ok) {
                         throw new Error(datos.message || 'Error al buscar');
                    }
                    
                    let producto = datos.payload; 

                    if (producto) {
                        console.table(producto);
                        // Aseguramos que usamos 'nombreProducto'
                        let htmlProducto = `
                            <li class="li-listados" style="list-style-type: none; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                <img src="${producto.imagen || 'https://via.placeholder.com/100x100.png?text=Sin+Imagen'}" alt="${producto.nombreProducto}" style="width:100px; height:100px; object-fit:cover; border-radius: 4px;">
                                <p>ID: ${producto.id}</p>
                                <h3 style="margin-top: 10px;">${producto.nombreProducto}</h3>
                                <p>Precio: $${producto.precio}</p>
                                <p>Tipo: ${producto.tipo}</p> 
                            </li>
                        `;
                        listaProductos.innerHTML = htmlProducto;
                    
                    } else {
                        // Si 'producto' es 'null' (no se encontró)
                        listaProductos.innerHTML = `<p>No se encontró ningún producto con el ID: ${idProd}</p>`;
                    }
                    
                } catch (error) {
                    console.log(error);
                    
                    Swal.fire({
                        title: 'Error',
                        text: `Ocurrió un error al buscar el producto: ${error.message}`,
                        icon: 'error'
                    });
                }
            });
        });
    </script>

</body>
</html>
